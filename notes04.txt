Ubuntu Server 上 dnsmasq 启动失败，日志显示端口53被占用。这是一个非常典型且常见的问题。

根本原因在于，现代的 Ubuntu Server 系统（自 16.10 版本以后）默认使用 systemd-resolved 服务来处理 DNS 解析，而这个服务会启动一个本地DNS "stub" 监听器，占用本地的 127.0.0.53:53 地址。当 dnsmasq 尝试启动并监听所有接口的53端口时，就会发现该端口已被占用，从而导致启动失败。

要解决这个问题，您需要禁用 systemd-resolved 的 stub 监听器，释放端口53，然后再启动 dnsmasq。

请按照以下步骤操作：

第1步：确认占用端口53的进程

首先，我们用命令来验证确实是 systemd-resolved 占用了端口53。

Bash
sudo ss -tulnp | grep ":53"
您很可能会看到类似下面的输出，其中明确显示了 systemd-resolve 进程：

udp   UNCONN  0  0    127.0.0.53:53      0.0.0.0:* users:(("systemd-resolve",pid=1234,fd=13))
tcp   LISTEN  0  0    127.0.0.53:53      0.0.0.0:* users:(("systemd-resolve",pid=1234,fd=12))
如果确认是 systemd-resolved，请继续执行第2步。如果显示的是其他进程（例如 named），那么您需要停止并禁用那个相应的服务。

第2步：修改 systemd-resolved 配置以释放端口53

我们需要编辑 systemd-resolved 的配置文件，告诉它不要再监听端口53。

打开配置文件
使用您喜欢的文本编辑器（如 nano 或 vim）打开配置文件：

Bash
sudo nano /etc/systemd/resolved.conf
修改配置项
在文件中找到 [Resolve] 部分，进行以下两项修改：

找到 #DNSStubListener=yes 这一行，去掉前面的 # 注释符，并将 yes 改为 no。

代码段
DNSStubListener=no
作用：这是最关键的一步，它会关闭在 127.0.0.53 上的DNS stub监听器，从而释放端口53。

（可选但推荐）您可以顺便设置一下 systemd-resolved 自己使用的上游DNS服务器。找到 #DNS= 这一行，去掉注释并设置为可靠的公共DNS，例如：

代码段
DNS=8.8.8.8 1.1.1.1 223.5.5.5
作用：这会让系统本身的解析（在 dnsmasq 启动前或不通过它时）依然能够工作。

修改完成后，保存并关闭文件 (在 nano 中是 Ctrl+X，然后按 Y，再按 Enter)。

第3步：更新系统的 /etc/resolv.conf 文件

systemd-resolved 管理着 /etc/resolv.conf 文件。在禁用了 stub 监听器后，我们需要确保这个文件指向正确的解析器配置，而不是已经被关闭的本地 stub。

systemd-resolved 会在 /run/systemd/resolve/resolv.conf 路径下生成一个包含上游DNS服务器列表的真实配置文件。我们需要将系统的 /etc/resolv.conf 软链接到这个文件上。

Bash
sudo ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf
命令解释:

ln -s: 创建一个符号链接（soft link）。

-f: 如果目标文件 (/etc/resolv.conf) 已经存在，则强制覆盖它。

第4步：重启服务并启动 dnsmasq

现在，我们应用刚才的配置并启动 dnsmasq。

重启 systemd-resolved 服务 使配置生效：

Bash
sudo systemctl restart systemd-resolved
启动 dnsmasq 服务：

Bash
sudo systemctl start dnsmasq
检查 dnsmasq 状态 确认它是否成功运行：

Bash
sudo systemctl status dnsmasq
如果看到 Active: active (running) 的绿色字样，说明 dnsmasq 已成功启动。

设置 dnsmasq 开机自启（如果需要的话）：

Bash
sudo systemctl enable dnsmasq
总结

通过以上四个步骤，您应该已经成功解决了端口冲突问题。核心思路是：

诊断：用 ss 命令确认是 systemd-resolved 占用了端口53。

配置：修改 /etc/systemd/resolved.conf，设置 DNSStubListener=no 来释放端口。

链接：更新 /etc/resolv.conf 软链接，确保系统DNS解析正常。

重启：重启 systemd-resolved 和 dnsmasq 服务。

现在您的 dnsmasq 应该可以正常工作了。
